{% extends "candidate/base.html" %}
{% load static %}
{% block title %}AMP Tech | Resume{% endblock title %}
{% block additionalCSS%}
<style>

    input::placeholder{
        color: #ddd !important;
    }
</style>
{% endblock additionalCSS%}
{% block content %}
<link rel="stylesheet" href="{% static 'candidate/css/external.css' %}" type="text/css">
<div class="container" style="height:100%; padding-top:5%" >

<!--        <div class="row"  id="ref">-->
<!--                <div class="col-4"></div>-->
<!--                <div class="col-4 text-center" >-->
<!--                    <label for="refer">Referred by : </label>-->
<!--                    <input type="text" class="form-control" name="refer" value="" id="refer">-->
<!--                    <small class="text-muted">Let us know how you found us.</small>-->
<!--                </div>-->
<!--                <div class="col-4"></div>-->

<!--            -->
<!--            <div class="f">-->
<!--                    <a class="next">Next &raquo;</a>-->
<!--            </div>-->
<!--        </div>-->

        
        </div>

            <div id="resumeUploadDiv">
            <div class="row">
                <div class="col-12 text-center" >
                    <h2>Upload Your Resume and Get Started</h2>
                </div>
            </div>
            <div class="row"style="padding:3%; ">
                <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Upload</span>
                </div>
                <div class="custom-file">
                    <input type="file" accept=".pdf" onchange="uploadGetURL()" class="custom-file-input" id="resumePDF">
                    <label class="custom-file-label" for="resumePDF">Resume</label>
                </div>
                <div class="text-center" id="msg" style="width:100%">
                        <small>Only PDFs are allowed</small>
                </div>
                </div>
            </div>
            <div class="col-12 text-center">
                    <input type="text" name="link" value="" id="resumeLink" hidden>
                    <button type="submit" id="getInterview" onclick="addPDF(event);" class="btn btn-success" name="button" disabled>Submit</button>
                </div>

        </div>
        
        {% url 'profile' as destination %}
    
 <button onclick="window.location.href='{{destination}}'" style="display:none;" id="theNextButton" formmethod="get"></button>
<!--        <form action="{% url 'jobInterview' %}" method="post">{% csrf_token %}-->
<!--            <div style="display: none">-->
<!--                <input type="text" name="job" value="{{job}}" hidden>-->
<!--                <button type="submit" name="button" id="jobInterviewButton"></button>-->
<!--            </div>-->
<!--        </form>-->


    </div>
 
{% endblock content %}

{% block additionalJS %}
<script>
    //refresh logic for avoiding resubmissions

    if (window.history.replaceState) {
        window.history.replaceState(null, null, window.location.href);
    }

    //Main ajax calls
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
            }
        }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    function sameOrigin(url) {
        // test that a given url is a same-origin URL
        // url could be relative or scheme relative or absolute
        var host = document.location.host; // host + port
        var protocol = document.location.protocol;
        var sr_origin = '//' + host;
        var origin = protocol + sr_origin;
        // Allow absolute or scheme relative URLs to same origin
        return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
        // or any other URL that isn't scheme relative or absolute i.e relative.
        !(/^(\/\/|http:|https:).*/.test(url));
    }

    function addPDF(event) {
        $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
            // Send the token to same-origin, relative URLs only.
            // Send the token only if the method warrants CSRF protection
            // Using the CSRFToken value acquired earlier
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
            $('#wait').show();
        }
        });
        data = {
            'link' : document.getElementById('resumeLink').value,
            }
        event.preventDefault();
        $.ajax({
            url: `{% url 'Resume_upload' %}`,
            type: 'POST',
            dataType: "json",
            data: data,
            success: function (data) {
                $('#theNextButton').click();
            },
            complete: function() {
                $('#wait').hide();
             },
        });
    };
</script>
<script defer src="https://www.gstatic.com/firebasejs/6.3.0/firebase-app.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/6.3.0/firebase-storage.js"></script>
<script defer src="{% static 'candidate/js/init-firebase.js' %}"></script>
<!-- firebase logic -->
<script>
    function uploadGetURL() {

        if (document.getElementById('resumePDF').files.length != 0) {
            file = document.getElementById('resumePDF').files[0];
            var storageRef = firebase.storage().ref();
            var videoResume = storageRef.child('resume/{{request.session.email}}/');
            var uploadTask = videoResume.put(file);
            uploadTask.on('state_changed', function(snapshot){
              // Observe state change events such as progress, pause, and resume
              // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
              var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              // console.log('Upload is ' + progress + '% done');
              $('#msg').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span><h5>Uploading ' + progress + '% </h5>');
              switch (snapshot.state) {
                case firebase.storage.TaskState.PAUSED: // or 'paused'
                  console.log('Upload is paused');
                  $('#msg').html('<h5>Upload is paused</h5>');
                  break;
                case firebase.storage.TaskState.RUNNING: // or 'running'
                  console.log('Upload is running');
                  break;
              }
            }, function(error) {
              // Handle unsuccessful uploads
            }, function() {
              // Handle successful uploads on complete
              // For instance, get the download URL: https://firebasestorage.googleapis.com/...
              uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
                // console.log('File available at', downloadURL);
                $('#msg').html('<h5>Uploaded</h5>');
                $('#resumeLink').val(downloadURL);
                $('#getInterview').attr("disabled", false);
              });
            });
        } else {
            $('#msg').html('<h5>Please Retry</h5>');
        }
    }
</script>
{% endblock additionalJS %}
